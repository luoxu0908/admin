<div id="filters" class="large-12 columns">
</div>
<div id="sortorder" class="large-12 columns">
</div>
<div id="MTool" class="large-12 columns">
	<button id="DoExportBtn" onclick="DoExport(); return false;" disabled style="margin-top:0.85em;">Run / Export</button>
</div>
<script>
	//bind to custom togShowHide event
	var $filters = $('#filters'), $sortorder = $('#sortorder'), $MTool = $('#MTool');
	$(document).on("togShowHide", function (e) {
		if (e.Show) { $filters.show(); $sortorder.show(); $MTool.show(); } else { $filters.hide(); $sortorder.hide(); $MTool.hide(); }
	});
	//init
	$('#DoExportBtn').disable(true);
	if (QS.ExportWebPartID || QS.DefineURL) {
		if (!QS.title) SetPageTitle(QS.ExportWebPartID || 'Report');
		var DefineURL = '';
		if (QS.ExportWebPartID) { DefineURL = QS.ExportWebPartID + '?Define'; }
		if (QS.DefineURL) { DefineURL = QS.DefineURL; }
		$.JSONPost(DefineURL)
		.done(function (data) {
			if (data.d.RetData.ParamList) {
				window.ExportType = 'GenericSQL';
				var PRows = data.d.RetData.ParamList.Rows;
				var RowCnt = PRows.length;
				if (RowCnt > 0) {
					$.each(PRows, function (index, Row) {
						var DispLbl = (Row.UIParam5 || '')
						if (DispLbl.length == 0) DispLbl = Row.ParamName;
						switch ((Row.UIDirective || "").toLowerCase()) {
							case "datepicker":
								$filters.append('<div class="row"><div class="large-3 columns end"><label for="' + Row.ParamName + '">' + DispLbl + '</label><input class="GetField datepicker" id="' + Row.ParamName + '" type="text" /></div></div>');
								break;
							case "select":
								$filters.append('<div class="row"><div class="large-3 columns end"><label for="' + Row.ParamName + '">' + DispLbl + '</label><input class="GetField select2" id="' + Row.ParamName + '" type="hidden" style="width:100%" /></div></div>');
								var seldata = [];
								var proc = (Row.UIParam1 || '').split(String.fromCharCode(8226));
								var proc2 = (Row.UIParam2 || '').split(String.fromCharCode(8226));
								if (proc.length == proc2.length) {
									for (var i = 0; i < proc.length; i++) {
										seldata.push({ id: proc[i], text: proc2[i] });
									}
								} else {
									for (var i = 0; i < proc.length; i++) {
										seldata.push({ id: proc[i], text: proc[i] });
									}
								}
								var element = document.getElementById(Row.ParamName);
								$(element).select2({ data: seldata });
								if (Row.UIParam3) { $(element).select2('val', Row.UIParam3); } else if (proc.length == 1) { $(element).select2('val', proc[0]); }
								break;
							default:
								//'"nchar", "ntext", "nvarchar", "text", "varchar", "char"
								//'"money", "int", "decimal", "smallint", "numeric", "tinyint", "float", "bigint"
								//'"date" "datetime", "smalldatetime", "uniqueidentifier", "bit"
								//'"image", "varbinary"
								switch ((Row.OutputType || "").toLowerCase()) {
									case "date":
										$filters.append('<div class="row"><div class="large-3 columns end"><label for="' + Row.ParamName + '">' + DispLbl + '</label><input class="GetField datepicker" id="' + Row.ParamName + '" type="text" /></div></div>');
										break;
									default:
										$filters.append('<div class="row"><div class="large-3 columns end"><label for="' + Row.ParamName + '">' + DispLbl + '</label><input class="GetField" id="' + Row.ParamName + '" type="text" /></div></div>');
										break;
								}
								break;
						}
					});
				}
				$('#DoExportBtn').disable(false);
				if (RowCnt == 0) DoExport();
			} else if (data.d.RetData.ColumnList) {
				window.ExportType = 'ViewOrTbl';
				var CRows = data.d.RetData.ColumnList.Rows;
				var RowCnt = CRows.length;
				if (RowCnt > 0) {
					var FieldChk = "";
					window.CriteriaCnt = 0;
					window.SortOrderCnt = 0;
					window.FieldOpt = '<option value="">- Select a field -</option>';
					$.each(CRows, function (index, Row) {
						FieldChk += '<label style="display:inline; margin-bottom:0.85em; margin-right:2em; white-space:nowrap;"><input type="checkbox" class="SelCol" style="display:inline; margin-bottom:0.85em;" id="SelFields|' + index + '" value="' + Row.ColumnName + '" checked>&nbsp;' + Row.ColumnName + '</label>\n';
						window.FieldOpt += '<option value="' + Row.ColumnName + '">' + Row.ColumnName + '</option>';
					});
					if (FieldChk) $filters.append('<div class="row"><div class="large-12 columns end"><label>Columns to return <a href="#" onclick="SelAllCol(); return false;">Select All</a>&nbsp;<a href="#" onclick="DeselAllCol(); return false;">Deselect All</a></label>' + FieldChk + '</div></div>');
					$filters.append('<div class="row"><div class="large-2 columns end"><label for="__TOPXNoOfRows">Max. rows to return</label><input class="GetField" id="__TOPXNoOfRows" type="text" value="9999" /></div></div>');
					$filters.append('<div class="row"><div class="large-12 columns end"><label>Filter criteria&nbsp;<a href="#" onclick="AddCriteria(); return false;">add</a></label></div></div>');
					AddCriteria();
					$sortorder.append('<div class="row"><div class="large-12 columns end"><label>Sort by&nbsp;<a href="#" onclick="AddSortOrder(); return false;">add</a></label></div></div>');
					$('#DoExportBtn').disable(false);
				}
			}
			$('.datepicker').datepicker({ 'changeMonth': true, 'changeYear': true, 'dateFormat': 'dd M yy' });
		});
	} else { alert('Developer alert: Please specify the querystring ExportWebPartID OR ReportID'); }
	function SelAllCol() { $('.SelCol').prop('checked', true); }
	function DeselAllCol() { $('.SelCol').prop('checked', false); }
	function AddCriteria() {
		window.CriteriaCnt += 1;
		$filters.append('<div class="row"><div class="large-2 columns"><label for="Criteria_' + window.CriteriaCnt + '">Column</label><select class="FCrit" id="Criteria_' + window.CriteriaCnt + '" style="width: 100%">' + window.FieldOpt + '</select></div><div class="large-1 columns"><label for="Comp_' + window.CriteriaCnt + '">Comparison</label><select id="Comp_' + window.CriteriaCnt + '" style="width: 100%"><option value="EQ">=</option><option value="GT">&gt;</option><option value="LT">&lt;</option><option value="GTE">&gt;=</option><option value="LTE">&lt;=</option><option value="NE">&lt;&gt;</option><option value="LIKE">LIKE</option><option value="NOT LIKE">NOT LIKE</option></select></div><div class="large-3 columns end"><label for="FilterVal_' + window.CriteriaCnt + '">Filter value</label><input id="FilterVal_' + window.CriteriaCnt + '" type="text" value="" /></div></div>');
	}
	function AddSortOrder() {
		window.SortOrderCnt += 1;
		$sortorder.append('<div class="row"><div class="large-2 columns"><label for="SortOrder_' + window.SortOrderCnt + '">Sort (#' + window.SortOrderCnt + ')</label><select class="SCrit" id="SortOrder_' + window.SortOrderCnt + '" style="width: 100%">' + window.FieldOpt + '</select></div><div class="large-1 columns end"><label for="Dirn_' + window.SortOrderCnt + '">Order</label><select id="Dirn_' + window.SortOrderCnt + '" style="width: 100%"><option value="ASC">Ascending</option><option value="DESC">Descending</option></select></div></div>');
	}
	//provide function to return data for filtering (e.g. for slickgrid)
	function DoExport() {
		$('#DoExportBtn').disable(true);
		setTimeout(function () { $('#DoExportBtn').disable(false); }, 1000);
		var Data = { };
		$('.GetField').each(function () {
			var ParamName = $(this).attr('id');
			if ($(this).is('[type="text"], textarea')) {
				if ($(this).val() == $(this).attr('title')) {
					Data[ParamName] = "";
				} else {
					Data[ParamName] = $(this).val();
				}
			} else if ($(this).is('[type="radio"]')) {
				var category = $(this).attr('name');
				$('input[name="' + category + '"]').each(function () {
					if ($(this).is(':checked')) {
						Data[ParamName] = $(this).val();
					}
				});
			} else if ($(this).is('[type="checkbox"]')) {
				if ($(this).is(':checked')) {
					Data[ParamName] = $(this).val();
				}
			} else if ($(this).is('[type="hidden"]') && ($(this).data('select2'))) {
				Data[ParamName] = $(this).val();
			} else if ($(this).is('select')) {
				Data[ParamName] = $(this).children('option:selected').val();
			}
		});
		if (window.ExportType == 'ViewOrTbl') {
			Data.SelectCols = [];
			$('.SelCol').each(function () { //checkbox for selected columns
				if ($(this).is(':checked')) {
					Data.SelectCols.push($(this).val());
				}
			});
			Data.FilterCriteria = [];
			$('.FCrit').each(function () { //filter criteria
				var Idx = $(this).attr('id').split("_")[1];
				Data.FilterCriteria.push({ ColName: $(this).val(), Comp: $('#Comp_' + Idx).children('option:selected').val(), Val: $('#FilterVal_' + Idx).val() });
			});
			Data.SortOrder = [];
			$('.SCrit').each(function () { //sort order
				var Idx = $(this).attr('id').split("_")[1];
				Data.SortOrder.push({ ColName: $(this).val(), Dirn: $('#Dirn_' + Idx).children('option:selected').val() });
			});
		}

		var GenURL = '';
		if (QS.ExportWebPartID) { GenURL = QS.ExportWebPartID; }
		if (QS.GenURL) { GenURL = QS.GenURL; }
		$.JSONPostNewWindow(GenURL, Data);
	}
</script>

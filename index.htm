<!DOCTYPE html>
<!--[if lt IE 7]><html class="lt-ie9 lt-ie8 lt-ie7" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><![endif]-->
<!--[if IE 7]><html class="lt-ie9 lt-ie8" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><![endif]-->
<!--[if IE 8]><html class="lt-ie9" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><![endif]-->
<!--[if gt IE 8]><!-->
<html xmlns="http://www.w3.org/1999/xhtml">
<!--<![endif]-->
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title></title>
	<!-- <link rel="stylesheet" href="styles/normalize.css" /> -->
	<!-- <link rel="stylesheet" href="styles/foundation.min.css" /> -->
	<!-- <link rel="stylesheet" href="styles/ie8-grid-foundation-4.css" /> -->
	<!-- <link rel="stylesheet" href="styles/jquery-ui-1.8.18.css" media="all" /> -->
	<link rel="stylesheet" href="styles/main_new.css">
	<link rel="stylesheet" href="assets/css/amazeui.min.css" />
	<link rel="stylesheet" href="assets/css/amazeui.datatables.min.css" />
	<link rel="stylesheet" href="assets/css/app.css">
	<style>
		.red { color: Red; }
	</style>
	<noscript>Javascript is disabled<meta http-equiv="REFRESH" content="0; url=EnableJavascript.htm"> </noscript>
	<script src="scripts/vendor/custom.modernizr.js"></script>
</head>
<body style="overflow: hidden;">
	<nav class="row fullwidth bchide">
		<div class="small-12 columns" style="z-index: 30;">
			<div class="row">
				<div id="ShowMenu" class="small-12 columns" style="padding: 0; height: 35px; border-bottom: 1px solid #BBB;">
					<span class="systitle"></span>
					<div class="fixmenuitem profilem" style="padding: 9px 10px;">
						<span id="dispname"></span>
					</div>
					<div class="fixmenuitem homem" title="Home"></div>
					<div class="fixmenuitem more" title="More Items" style="display:inline;"></div>
				</div>
			</div>
			<div class="row bchide">
				<div class="small-12 columns">
					<div id="menudiv" class="bchide" style="overflow-y:auto;"></div>
				</div>
			</div>
			<div id="profilediv" class="txtright bchide">
				<ul id="profilemenu"></ul>
			</div>
		</div>
	</nav>
	<div id="content" class="row fullwidth">
		<div class="small-12 columns" style="padding: 0;">
			<div id="overlay" class="bchide">
				<div id="overlay_content"><img src="styles/images/loading.gif" style="display:inline; float:left;" />Loading. Please wait.</div>
			</div>
			<iframe id="contentframe" src="about:blank" frameborder="0"></iframe>
			<div id="ifrCDiv" style="display:none; overflow:auto; overflow-x:auto; overflow-y:auto; -webkit-overflow-scrolling:touch;">
			</div>
		</div>
	</div>
	<div id="msg" title="Information"></div>
	<script src="scripts/jquery-1.9.1.min.js"></script>
	<script src="scripts/foundation.min.js"></script>
	<script src="scripts/jquery-ui-1.9.2.min.js"></script>
	<script src="scripts/Master.js"></script>
	<script src="scripts/Security.js"></script>
	<noscript>Your browser does not support JavaScript!</noscript>
	<script>
		window.ifrC = $('#contentframe');
		window.ifrCDiv = $('#ifrCDiv'); //iOS compatability hack
		if (Utils.iOS()) window.ifrCDiv.append(window.ifrC).show();
		var timer = null; window.lastWindowHeight = 0; window.lastWindowWidth = 0; window.PID = 0, homeURL = 'landing.htm';
		function GetMenu(callback) {
			$.JSONPost('iCtc1.GetOwnPersonID.json')
				.done(function (data) {
					var R = data.d.RetData.Tbl.Rows, RowCnt = R.length;
					if (RowCnt > 0) { window.PID = R[0].PersonID; }
					$.JSONPost('Sec1.Menu.json', {})
						.done(function (data) {
							if ((data) && (data.d.RetVal === -1)) {
								BuildMenu(data.d.RetData.Tbl, function () { GetConfig(function () { setTimeout(function () { ResponsiveMenu(); if (callback && typeof (callback) === 'function') { callback(); } }, 500); }); });
							}
						});
				});
		}
		function BuildMenu(tbl, callback) {
			var R = tbl.Rows, RowCnt = R.length;
			var prevMenuName = '', $submenu = '', mainmenuList = [], submenuList = [], profilelist = [], prevMainMenu = '';
			// need to reverse because of the float right for the main menu items.
			var $mainmenu = $('#ShowMenu'), $profilemenu = $('#profilemenu');
			$('#ShowMenu > div.menuitem').remove(); $profilemenu.html('');
			$('#menudiv > div').remove();
			for (var i = 0; i < RowCnt; i++) {
				switch (R[i].MenuType.toLowerCase()) {
					case 'profilemenu': profilelist.push(R[i]);
						break;
					case 'home': homeURL = R[i].RelativeURL.substr(1);
						break;
					default:
						if (R[i].MenuName.indexOf('\\') > 0) {
							if (prevMainMenu === '' || prevMainMenu !== $.trim(R[i].MenuName.split('\\')[0])) {
								prevMainMenu = $.trim(R[i].MenuName.split('\\')[0]);
								mainmenuList.push(R[i]);
							}
							submenuList.push(R[i]);
						} else {
							if (prevMainMenu === '' || prevMainMenu !== $.trim(R[i].MenuName)) {
								prevMainMenu = $.trim(R[i].MenuName);
								mainmenuList.push(R[i]);
							}
							submenuList.push(R[i]);
						}
						break;
				}
			}
			// build the profile menu using profilelist
			for (var i = 0; i < profilelist.length; i++) {
				var URL = '', cssClass = 'profilemenuitem';
				URL = (profilelist[i].RelativeURL.indexOf('/') === 0) ? profilelist[i].RelativeURL.substring(1) : profilelist[i].RelativeURL;
				if (URL.indexOf('{{PID}}') >= 0) {
					URL = URL.replace('{{PID}}', window.PID);
				}
				if (profilelist[i].DefaultCSS !== '') {
					cssClass += ' ' + profilelist[i].DefaultCSS;
				}
				$profilemenu.append($('<li onclick="ChangeFrameSrc(\'' + URL + '\'); return false;">').html('<span class="' + cssClass + '">' + profilelist[i].MenuName + '</span>'));
			}
			$profilemenu.append($('<li class="logout">').html('<span><span style="margin-left: 20px;">Logout</span></span>'));
			// build the main menu using mainmenuList
			$submenu = $('#menudiv'); mainmenuList.reverse(); prevMainMenu = '';
			for (var i = 0; i < mainmenuList.length; i++) {
				var URL = '', menuname = '';
				URL = (mainmenuList[i].RelativeURL.indexOf('/') === 0) ? mainmenuList[i].RelativeURL.substring(1) : mainmenuList[i].RelativeURL;
				menuname = (mainmenuList[i].MenuName.indexOf('\\') >= 0) ? $.trim(mainmenuList[i].MenuName.split('\\')[0]) : $.trim(mainmenuList[i].MenuName);
				$mainmenu.append($('<div class="menuitem ' + mainmenuList[i].DefaultCSS + '" data-submenuid="sub' + (mainmenuList.length - i) + '" data-url="' + URL + '" tabindex="' + (mainmenuList.length - i) + '">').html('<a href="#">' + menuname + '</a>'));
			}
			// build the sub menu using submenuList
			var cnt = 0;
			for (var i = 0; i < submenuList.length; i++) {
				var menuOpt = submenuList[i].MenuName.split('\\');
				if (prevMainMenu === '' || prevMainMenu !== $.trim(menuOpt[0])) {
					prevMainMenu = $.trim(menuOpt[0]);
					$submenu.append($('<div id="sub' + (cnt += 1) + '" class="bchide">').html('<ul style="list-style: none;"><li class="submenutitle bchide">' + $.trim(menuOpt[0]) + '</li><li><ul style="list-style: none;"></ul></li></ul>'));
				}
				var $submenulist = $('#sub' + cnt).children('ul').children('li:last').children('ul'), URL = '';
				URL = (submenuList[i].RelativeURL.indexOf('/') === 0) ? submenuList[i].RelativeURL.substring(1) : submenuList[i].RelativeURL;
				var TF = (submenuList[i].TargetFrame || "");
				if (URL !== '') {
					if (TF !== '') {
						$submenulist.append($('<li>').html('<a href="' + URL + '" target="' + TF + '" title="' + ($.trim(menuOpt[1]) || 'Home') + '" class="' + submenuList[i].DefaultCSS + ' sub">' + ($.trim(menuOpt[1]) || 'Home') + '</a>'));
					} else {
						$submenulist.append($('<li>').html('<a href="#" onclick="ChangeFrameSrc(\'' + URL + '\', true); return false;" title="' + ($.trim(menuOpt[1]) || 'Home') + '" class="' + submenuList[i].DefaultCSS + ' sub">' + ($.trim(menuOpt[1]) || 'Home') + '</a>'));
					}
				}
			}

			if (callback && typeof (callback) === 'function') { callback(); }
		}
		function ResponsiveMenu(callback) {
			var $mainmenu = $('.menuitem'), $submenu = $('#menudiv > div'), $submenudiv = $('#menudiv'), $submenutitle = $('.submenutitle');
			$mainmenu.removeClass('bchide').removeClass('selected'); $submenu.addClass('bchide'); $submenutitle.addClass('bchide'); $submenudiv.addClass('bchide').parent().parent().addClass('bchide').removeClass('submenuborder');
			var hiddenEleCnt = 0;
			if ($('.menuitem:visible').length > 0) {
				$('.menuitem:visible').each(function (e) {
					if ($(this).offset().top > 10) {
						hiddenEleCnt += 1;
					}
				});
				if (hiddenEleCnt > 0) {
					$('.more').removeClass('bchide');
					var tempEleCnt = 0;
					while (hiddenEleCnt !== 0) {
						var id = $('.menuitem:visible:first').data('submenuid');
						$('.menuitem:visible:first').addClass('bchide');
						$('#' + id).removeClass('bchide').children('ul').children('li:first').removeClass('bchide');
						hiddenEleCnt = 0;
						$('.menuitem:visible').each(function () {
							if ($(this).offset().top > 10) {
								hiddenEleCnt += 1;
							}
						});
					}
				} else if (!($submenu.is(':visible')).length > 0) {
					$('.more').addClass('bchide');
					$('.selected').removeClass('selected');
					if ($submenudiv.is(':visible')) { $submenudiv.addClass('bchide').parent().parent().addClass('bchide').removeClass('submenuborder'); }
				} else {
					$('.more').css({ 'display': 'inline-block' });
					if ($submenudiv.is(':visible')) { $submenudiv.addClass('bchide').parent().parent().addClass('bchide').removeClass('submenuborder'); }
				}
				if (callback && typeof (callback) === 'function') { callback(); }
			} else {
				$submenu.removeClass('bchide');
				$submenutitle.removeClass('bchide').addClass('show');
				$('.menuitem.selected').removeClass('selected');
				if (callback && typeof (callback) === 'function') { callback(); }
			}
		}
		function ResponsiveDropDown() {
			var $submenudiv = $('#menudiv');
			ResponsiveMenu(function () {
				$submenudiv.removeClass('bchide').parent().parent().removeClass('bchide').addClass('submenuborder');
				if ($submenudiv.height() > $(window).height()) {
					$submenudiv.css({ height: $(window).height() - 100 });
				} else {
					$submenudiv.css({ height: 'auto' });
				}
			});
			var $submenu = $('#menudiv > div');
			if (($submenu.is(':visible')).length >= 1) {
				$('#menudiv > div.show:first > ul > li:first').css({ 'margin': '0', 'text-decoration': '' });
				($submenu.is(':visible')).each(function (index) {
					$(this).children('ul').children('li:first').css({ 'text-decoration': 'underline' });
					if (index >= 1) {
						$(this).children('ul').children('li:first').css({ 'margin-top': '15px' });
					}
				});
			}
		}
		function NavMenu() {
			$('#ShowMenu').on('click', '.menuitem', function (e) {
				e.preventDefault();
				var $selitem = $(this);
				var $submenuid = $('#' + $selitem.data('submenuid'));
				var $submenu = $('#menudiv > div');
				var $submenudiv = $('#menudiv');
				var IsSel = ($selitem.hasClass('selected'));
				var profile = $('#profilediv');
				profile.addClass('bchide'); // hide profile when menu selected
				if (IsSel) {
					if ($(window).width() < 760) {
						$selitem.removeClass('selected');
						$submenu.addClass('bchide');
						$submenudiv.addClass('bchide').parent().parent().addClass('bchide').removeClass('submenuborder');
					} else {
						ChangeFrameSrc($selitem.data('url'));
					}
				} else {
					$submenu.addClass('bchide');
					$('.selected').removeClass('selected');
					if ($submenuid.length > 0) {
						$submenuid.removeClass('bchide');
						$submenudiv.removeClass('bchide').parent().parent().addClass('submenuborder').removeClass('bchide');
						$selitem.addClass('selected');
					}
					ChangeFrameSrc($selitem.data('url'));
				}
				$submenudiv.css({ height: 'auto' });
			});
		}
		function GetConfig(callback) {
			$.JSONPost('Main1.GetLookup.json', { 'TblName': 'tblMainLookup', 'LookupCat': 'MenuConfig', 'LookupKey': 'Title,Color,ShowHome' })
				.done(function (data) {
					var R = data.d.RetData.Tbl.Rows, RowCnt = R.length, title = '', color = '', showhome = 1;
					if (RowCnt > 0) {
						for (var i = 0; i < RowCnt; i++) {
							switch (R[i].LookupKey.toLowerCase()) {
								case 'title': title = R[i].Description;
									break;
								case 'color': color = R[i].Description;
									break;
								case 'showhome': showhome = parseInt(R[i].Description);
							}
						}
					}
					if (title == '') { $('.systitle, title').html('BizSense'); } else { $('.systitle, title').html(title); }
					if (showhome == 0) { $('.homem').addClass('bchide'); }
					if (callback && typeof (callback) === 'function') { callback(); }
				});
		}
		function ResizeMainC() {
			var newheight = 0, vpHeight = 0;
			if ($.cookie('CurrPage') !== null) {
				vpHeight = $(window).height() - $('nav').height();
			} else {
				vpHeight = $(window).height();
			}
			var CssVal = { 'height': vpHeight + 'px', 'width': $(window).width() + 'px' };
			window.ifrC.css(CssVal);
			if (Utils.iOS()) window.ifrCDiv.css(CssVal);
		}
		window.ChangeFrameSrc = function (url, isSubMenu) {
			$('#overlay').removeClass('bchide');
			isSubMenu = (isSubMenu) ? isSubMenu : false;
			if ($.cookie('CurrPage') === null) {
				// this is to check that only when redirect from login page, then get the menu.
				$('nav').removeClass('bchide');
			}
			var $profile = $('#profilediv');
			if (!($profile.hasClass('bchide'))) {
				$profile.addClass('bchide'); $('.profilem').removeClass('selected');
			}
			if ($('.more.selected').length > 0) { // if more is selected, then hide the submenu
				var $submenudiv = $('#menudiv'), $more = $('.more');
				$submenudiv.addClass('bchide').parent().parent().addClass('bchide').removeClass('submenuborder');
				$more.removeClass('selected');
				$submenudiv.css({ height: 'auto' });
			}
			vpHeight = $(window).height() - $('nav').height();
			$('#overlay').css({ 'height': vpHeight + 'px' }); $('#overlay_content').css({ 'margin-top': (vpHeight / 2) + 'px' });
			$.cookie('CurrPage', url);
			ResizeMainC();
			$('#contentframe').attr('src', url);
			$('#contentframe').load(function () {
				$('#overlay').addClass('bchide');
			});
		}
		$(document).ready(function () {
			CookieIsActive();
			var vpHeight = 0;
			LoginInfo().done(function (data) {
				// not login, redirect to login page
				if (data.d.RetData.LoginID <= 0) {
					window.top.location = 'login.htm';
				} else {
					$('#dispname').append(data.d.RetData.DispName);
					if ($.cookie('Menu') !== null && parseInt($.cookie('Menu')) === 0) { } else { $('nav').removeClass('bchide'); GetMenu(); }
					if ($.cookie('CurrPage') !== null) {
						ChangeFrameSrc($.cookie('CurrPage'));
					} else {
						ChangeFrameSrc('landing.htm');
					}
				}
			});
			$('#msg').dialog({
				'autoOpen': false, 'modal': true, 'resizable': false, 'draggable': false, 'minWidth': 300,
				buttons: {
					'Ok': function () {
						$(this).dialog('close');
					}
				}
			});
			$(window).resize(function () {
				if ((window.lastWindowHeight === 0 && window.lastWindowWidth === 0) || (window.lastWindowHeight !== $(window).height()) || (window.lastWindowWidth !== $(window).width())) {
					$('.more.selected').removeClass('selected');
					window.lastWindowHeight = $(window).height(); window.lastWindowWidth = $(window).width();
					if (timer !== null) {
						clearTimeout(timer);
					}
					timer = setTimeout(function () {
						if ($.cookie('CurrPage') !== null) {
							ResponsiveMenu(function () { ResizeMainC(); });
						} else {
							$('nav').addClass('bchide');
							ResizeMainC();
						}
						timer = null;
					}, 200);
				}
			});
			$('.more').click(function (e) {
				e.preventDefault();
				var $more = $('.more'), $submenudiv = $('#menudiv'), $selItms = $('.selected');
				var profile = $('#profilediv');
				profile.addClass('bchide'); // hide profile when menu selected
				if ($more.hasClass('selected')) {
					$submenudiv.addClass('bchide').parent().parent().removeClass('submenuborder').addClass('bchide');
					$more.removeClass('selected');
					$submenudiv.css({ height: 'auto' });
				} else {
					$selItms.removeClass('selected');
					$more.addClass('selected');
					$submenudiv.removeClass('bchide').parent().parent().addClass('submenuborder').removeClass('bchide');
					ResponsiveDropDown();
				}
			});
			$('.profilem').click(function () {
				var $profile = $('#profilediv'), isSel = $(this).hasClass('selected');
				var $submenudiv = $('#menudiv').parent().parent(), $submenu = $('.menuitem.selected'); $fixmenu = $('.fixmenuitem.selected');
				$submenudiv.addClass('bchide'); $submenu.removeClass('selected'); $fixmenu.removeClass('selected');
				if (isSel) {
					$profile.addClass('bchide'); $(this).removeClass('selected');
				} else {
					$profile.removeClass('bchide'); $(this).addClass('selected');
				}
				ResizeMainC();
			});
			$('#profilemenu').on('click', '.logout', function (e) {
				e.preventDefault();
				$.JSONPost('Sec1.Logout.json', {})
					.then(function (data) {
						$.cookie('CurrPage', null, { 'expires': 1 }); $('nav').addClass('bchide');
						window.top.location = (data.d.RetData || 'index.htm');
					});
			});
			$('.homem').click(function (e) {
				e.preventDefault(); isProfileSel = $('.profilem').hasClass('selected');
				if (isProfileSel) {
					$('#profilediv').addClass('bchide'); $('.profilem').removeClass('selected');
				}
				//deselect and close submenu
				$('.selected').removeClass('selected');
				$('#menudiv > div').addClass('bchide');
				$('#menudiv').addClass('bchide').parent().parent().addClass('bchide').removeClass('submenuborder');
				ChangeFrameSrc(homeURL);
			});
			NavMenu();
		});
	</script>
</body>
</html>
